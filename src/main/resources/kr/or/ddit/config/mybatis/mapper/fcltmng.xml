<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="fcltmng">
	<!-- 시설관리 -->
	<!-- 시설리스트 조회 -->
	<select id="myfcltmngList" resultType="fcltmngVo">
		SELECT
		control_no,msr_code,owner,location,info,use,reg_dt
		FROM fcltmng
	</select>

	<!-- 등록된 시설 보는거 03/04 (경찬) -->
	<select id="fcltmngCount" parameterType="String"
		resultType="Integer">
		SELECT count(*)
		FROM fcltmng
		WHERE owner = #{user_id}
	</select>

	<!-- 시설 상세 조회 -->
	<select id="fcltmngInfo" resultType="fcltmngVo"
		parameterType="String">
		SELECT
		f.control_no,f.msr_code,f.owner,f.location,f.info,c.code_nm
		item_code,f.reg_dt
		FROM fcltmng f,codes c
		WHERE control_no =
		#{control_no}
		AND f.item_code = c.code_no
	</select>

	<!--가장 최근 센서 정보 조회 -->
	<select id="latelyData" resultType="msrrecVo"
		parameterType="String">
		SELECT c.msr_no, p.msr_nm msr_code, c.msr_reg_dt,
		c.msr_temp , c.msr_humid, c.msr_bright
		FROM msrrec c, msrequip p
		WHERE
		MSR_REG_DT =
		(SELECT max(msr_reg_dt)
		KEEP(DENSE_RANK FIRST ORDER BY msr_reg_dt DESC)
		msr_reg_dt
		FROM msrrec
		WHERE msr_code =
		#{msr_code})
		AND
		c.msr_code = p.msr_code
	</select>

	<!-- 센서 기록 조회 -->
	<!-- 20210305KJH 수정 -->
	<select id="myfanalysisInfo" resultType="msrrecVo"
		parameterType="msrrecVo">
		SELECT ROUND(AVG(NVL(MSR_TEMP, 0)),0) MSR_TEMP,
		ROUND(AVG(NVL(MSR_HUMID, 0)),0) MSR_HUMID,
		ROUND(AVG(NVL(MSR_BRIGHT,
		0)),0) MSR_BRIGHT
		FROM msrrec
		WHERE msr_reg_dt &lt; sysdate-${msr_no}
		AND msr_reg_dt &gt;= sysdate-${msr_no}-1
		AND MSR_CODE = #{msr_code}
	</select>

	<!-- 센서 목록 조회 -->
	<select id="msrequipList" resultType="msrequipVo"
		parameterType="String">
		SELECT msr_code,msr_nm,owner,use
		FROM msrequip
		WHERE owner
		= #{OWNER}
	</select>
	
	<!-- 내 시설 실시간 관측 -->
	<select id="mymaxmsrrecList" resultType="mymaxmrreclistVo" parameterType="msrrecVo">
	select fc.location,fc.msr_code, co.code_nm, fc.reg_dt, rec.msr_temp,
	rec.msr_humid, rec.msr_bright
	from fcltmng fc, msrequip eq,
	(select msr_code,msr_reg_dt ,msr_temp,msr_humid,msr_bright
	from msrrec where msr_code = '${msr_code}'
	and msr_reg_dt = (select max(msr_reg_dt) from msrrec where msr_code = '${msr_code}')
	) rec,codes co
	where fc.msr_code = eq.msr_code
	and co.code_no = fc.item_code
	and eq.msr_code ='${msr_code}'
	</select>
</mapper>